name: Release Management

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.2.3)'
        required: true
        type: string

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: '20.x'
  PYTHON_VERSION: '3.11'

jobs:
  # ===========================================================================
  # VALIDATE RELEASE
  # ===========================================================================
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    timeout-minutes: 10

    outputs:
      version: ${{ steps.get_version.outputs.version }}
      is_prerelease: ${{ steps.check_version.outputs.is_prerelease }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Check version format
        id: check_version
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"

          # Validate semver format
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?(\+[a-zA-Z0-9.]+)?$ ]]; then
            echo "::error::Invalid version format: $VERSION"
            exit 1
          fi

          # Check if prerelease
          if [[ "$VERSION" =~ -[a-zA-Z] ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "This is a prerelease version"
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "This is a stable release"
          fi

      - name: Verify tag doesn't exist
        if: github.event_name == 'workflow_dispatch'
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "::error::Tag $VERSION already exists"
            exit 1
          fi

  # ===========================================================================
  # GENERATE CHANGELOG
  # ===========================================================================
  changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    needs: validate
    timeout-minutes: 10

    outputs:
      changelog: ${{ steps.changelog.outputs.changelog }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          VERSION="${{ needs.validate.outputs.version }}"

          # Get previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            echo "No previous tag found, generating changelog from all commits"
            PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
          fi

          echo "## ðŸ“ Changelog" > changelog.md
          echo "" >> changelog.md
          echo "### Changes from $PREVIOUS_TAG to $VERSION" >> changelog.md
          echo "" >> changelog.md

          # Features
          FEATURES=$(git log $PREVIOUS_TAG..HEAD --oneline --grep="^feat" --grep="^feature" -i || echo "")
          if [ ! -z "$FEATURES" ]; then
            echo "### âœ¨ Features" >> changelog.md
            echo "$FEATURES" | sed 's/^/- /' >> changelog.md
            echo "" >> changelog.md
          fi

          # Fixes
          FIXES=$(git log $PREVIOUS_TAG..HEAD --oneline --grep="^fix" --grep="^bugfix" -i || echo "")
          if [ ! -z "$FIXES" ]; then
            echo "### ðŸ› Bug Fixes" >> changelog.md
            echo "$FIXES" | sed 's/^/- /' >> changelog.md
            echo "" >> changelog.md
          fi

          # Performance
          PERF=$(git log $PREVIOUS_TAG..HEAD --oneline --grep="^perf" -i || echo "")
          if [ ! -z "$PERF" ]; then
            echo "### âš¡ Performance" >> changelog.md
            echo "$PERF" | sed 's/^/- /' >> changelog.md
            echo "" >> changelog.md
          fi

          # Documentation
          DOCS=$(git log $PREVIOUS_TAG..HEAD --oneline --grep="^docs" -i || echo "")
          if [ ! -z "$DOCS" ]; then
            echo "### ðŸ“š Documentation" >> changelog.md
            echo "$DOCS" | sed 's/^/- /' >> changelog.md
            echo "" >> changelog.md
          fi

          # Other changes
          echo "### ðŸ”§ Other Changes" >> changelog.md
          git log $PREVIOUS_TAG..HEAD --oneline --invert-grep --grep="^feat" --grep="^fix" --grep="^perf" --grep="^docs" -i | sed 's/^/- /' >> changelog.md

          # Output for GitHub
          {
            echo 'changelog<<EOF'
            cat changelog.md
            echo EOF
          } >> $GITHUB_OUTPUT

      - name: Upload changelog
        uses: actions/upload-artifact@v4
        with:
          name: changelog-${{ needs.validate.outputs.version }}
          path: changelog.md
          retention-days: 90

  # ===========================================================================
  # BUILD RELEASE ARTIFACTS
  # ===========================================================================
  build-artifacts:
    name: Build Release Artifacts
    runs-on: ubuntu-latest
    needs: validate
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Build frontend
        working-directory: ./frontend
        run: |
          npm ci --production
          npm run build
          tar -czf frontend-${{ needs.validate.outputs.version }}.tar.gz .next package.json

      - name: Build backend
        working-directory: ./backend
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          tar -czf backend-${{ needs.validate.outputs.version }}.tar.gz app requirements.txt

      - name: Generate checksums
        run: |
          cd frontend && sha256sum frontend-${{ needs.validate.outputs.version }}.tar.gz > checksums.txt
          cd ../backend && sha256sum backend-${{ needs.validate.outputs.version }}.tar.gz >> ../frontend/checksums.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts-${{ needs.validate.outputs.version }}
          path: |
            frontend/frontend-${{ needs.validate.outputs.version }}.tar.gz
            backend/backend-${{ needs.validate.outputs.version }}.tar.gz
            frontend/checksums.txt
          retention-days: 90

  # ===========================================================================
  # CREATE RELEASE
  # ===========================================================================
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate, changelog, build-artifacts]
    timeout-minutes: 15

    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Create/Update tag
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag -a ${{ needs.validate.outputs.version }} -m "Release ${{ needs.validate.outputs.version }}"
          git push origin ${{ needs.validate.outputs.version }}

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ needs.validate.outputs.version }}
          name: Release ${{ needs.validate.outputs.version }}
          body: ${{ needs.changelog.outputs.changelog }}
          draft: false
          prerelease: ${{ needs.validate.outputs.is_prerelease == 'true' }}
          artifacts: |
            artifacts/release-artifacts-${{ needs.validate.outputs.version }}/*.tar.gz
            artifacts/release-artifacts-${{ needs.validate.outputs.version }}/checksums.txt
          token: ${{ secrets.GITHUB_TOKEN }}
          generateReleaseNotes: true

  # ===========================================================================
  # POST-RELEASE TASKS
  # ===========================================================================
  post-release:
    name: Post-Release Tasks
    runs-on: ubuntu-latest
    needs: [validate, create-release]
    if: needs.validate.outputs.is_prerelease == 'false'
    timeout-minutes: 10

    steps:
      - name: Notify release
        run: |
          echo "## ðŸŽ‰ Release Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Type:** Stable Release" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY

      - name: Create announcement issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸŽ‰ Release ${{ needs.validate.outputs.version }} Published',
              body: `## Release ${{ needs.validate.outputs.version }}

              A new release has been published!

              **Download:** [${{ needs.validate.outputs.version }}](${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ needs.validate.outputs.version }})

              ### What to do next:
              - Review the changelog
              - Update deployment environments
              - Notify stakeholders

              ---
              *This issue was automatically created by the release workflow.*`,
              labels: ['release', 'announcement']
            });

  # ===========================================================================
  # ROLLBACK (Manual Trigger Only)
  # ===========================================================================
  rollback:
    name: Rollback Release
    runs-on: ubuntu-latest
    if: failure() && github.event_name == 'workflow_dispatch'
    needs: [validate, create-release]
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Delete tag
        run: |
          git push --delete origin ${{ needs.validate.outputs.version }} || echo "Tag not pushed yet"

      - name: Delete release
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo
            });

            const release = releases.data.find(r => r.tag_name === '${{ needs.validate.outputs.version }}');

            if (release) {
              await github.rest.repos.deleteRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: release.id
              });
            }
